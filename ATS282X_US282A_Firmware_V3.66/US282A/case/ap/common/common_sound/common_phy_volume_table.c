/********************************************************************************
 *        Copyright(c) 2014-2015 Actions (Zhuhai) Technology Co., Limited,
 *                            All Rights Reserved.
 *
 * 描述：物理音量管理接口，包括设置音量和获取音量；支持I2S。
 * 作者：cailizhen
 ********************************************************************************/

#include "psp_includes.h"
#include "music_common.h"
#include "common_func.h"
#include "ccd_interface.h"

#if ((CASE_LINEIN_CHANNEL_SEL == 0) || (CASE_FM_CHANNEL_SEL == 0))

//IC 内部 PA DB值，最高为0db，单位为0.1DB
const int16 g_ana_pa_db[ANA_PA_VOLUME_MAX] =
{
    -600, -600, -579, -552, -530, -512, -494, -476, -457, -437, -416, -394, -373, -353,
    -327, -312, -297, -281, -265, -250, -235, -221, -205, -190, -174, -159, -143,
    -128, -118, -109,  -99,  -89,  -79,  -69,  -59,  -49,  -39,  -29,  -20,  -10, 0,
};

//音量值 -> pa vol + da vol, step by 0.375db * N, or 1db, 1.6db, 2db, 3db
const vol_hard_t g_hard_volume_table[VOLUME_TABLE_MAX+1][VOLUME_VALUE_MAX+1] =
{
    //0db
    {
        /* 0db,     -0.375db,   -0.75db,    -1.375db,   -2db        -2.75db,    -3.375db,   -4db */
        {40, 0xbf}, {40, 0xbe}, {40, 0xbd}, {39, 0xbe}, {38, 0xbf}, {38, 0xbd}, {37, 0xbe}, {36, 0xbf},
        /* -4.75db, -5.375db,   -6db,       -6.75db,    -7.375db    -8db,       -8.75db,    -9.375db */
        {36, 0xbd}, {35, 0xbe}, {34, 0xbf}, {34, 0xbd}, {33, 0xbe}, {32, 0xbf}, {32, 0xbd}, {31, 0xbe},
        /* -10db,   -11db,      -12db,      -13db,      -14.3db     -15.8db,    -17.4db,    -19db */
        {30, 0xbf}, {29, 0xbf}, {28, 0xbf}, {27, 0xbf}, {26, 0xbf}, {25, 0xbf}, {24, 0xbf}, {23, 0xbf},
        /* -21.25db, -23.5db,   -25.75db,   -28.1db,    -31.2db     -35.3db,    -41.6db,    -60db */
        {22, 0xbd}, {20, 0xbf}, {19, 0xbd}, {17, 0xbf}, {15, 0xbf}, {13, 0xbf}, {10, 0xbf}, {0, 0xbf},
    },
    //-1db
    {
        /* -1db,    -1.375db,   -1.75db,    -2.375db,   -3db        -3.75db,    -4.375db,   -5db */
        {39, 0xbf}, {39, 0xbe}, {39, 0xbd}, {38, 0xbe}, {37, 0xbf}, {37, 0xbd}, {36, 0xbe}, {35, 0xbf},
        /* -5.75db, -6.375db,   -7db,       -7.75db,    -8.375db    -9db,       -9.75db,    -10.375db */
        {35, 0xbd}, {34, 0xbe}, {33, 0xbf}, {33, 0xbd}, {32, 0xbe}, {31, 0xbf}, {31, 0xbd}, {30, 0xbe},
        /* -11db,   -12db,      -13db,      -14.3db     -15.8db,    -17.4db,    -19db,      -20.5db */
        {29, 0xbf}, {28, 0xbf}, {27, 0xbf}, {26, 0xbf}, {25, 0xbf}, {24, 0xbf}, {23, 0xbf}, {22, 0xbf},
        /* -22.85db,   -25db,   -27.25db,   -29.7db     -32.7db,    -37.3db,    -43.7db,    -60db */
        {21, 0xbd}, {19, 0xbf}, {18, 0xbd}, {16, 0xbf}, {14, 0xbf}, {12, 0xbf}, {9, 0xbf},  {0, 0xbf},
    },
    //-2db
    {
        /* -2db,    -2.375db,   -2.75db,    -3.375db,   -4db        -4.75db,    -5.375db,   -6db */
        {38, 0xbf}, {38, 0xbe}, {38, 0xbd}, {37, 0xbe}, {36, 0xbf}, {36, 0xbd}, {35, 0xbe}, {34, 0xbf},
        /* -6.75db, -7.375db,   -8db,       -8.75db,    -9.375db    -10db,      -10.75db,   -11.375db */
        {34, 0xbd}, {33, 0xbe}, {32, 0xbf}, {32, 0xbd}, {31, 0xbe}, {30, 0xbf}, {30, 0xbd}, {29, 0xbe},
        /* -12db,   -13db,      -14.3db     -15.8db,    -17.4db,    -19db,      -20.5db,    -22.1db */
        {28, 0xbf}, {27, 0xbf}, {26, 0xbf}, {25, 0xbf}, {24, 0xbf}, {23, 0xbf}, {22, 0xbf}, {21, 0xbf},
        /* -24.25db,  -26.5db,  -28.85db,   -31.2db     -35.3db,    -39.4db,    -45.7db,    -60db */
        {20, 0xbd}, {18, 0xbf}, {17, 0xbd}, {15, 0xbf}, {13, 0xbf}, {11, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-3db
    {
        /* -3db,    -3.375db,   -3.75db,    -4.375db,   -5db        -5.75db,    -6.375db,   -7db */
        {37, 0xbf}, {37, 0xbe}, {37, 0xbd}, {36, 0xbe}, {35, 0xbf}, {35, 0xbd}, {34, 0xbe}, {33, 0xbf},
        /* -7.75db, -8.375db,   -9db,       -9.75db,    -10.375db   -11db,      -11.75db,   -12.375db */
        {33, 0xbd}, {32, 0xbe}, {31, 0xbf}, {31, 0xbd}, {30, 0xbe}, {29, 0xbf}, {29, 0xbd}, {28, 0xbe},
        /* -13db,   -14.3db     -15.8db,    -17.4db,    -19db,      -20.5db,    -22.1db,    -23.5db */
        {27, 0xbf}, {26, 0xbf}, {25, 0xbf}, {24, 0xbf}, {23, 0xbf}, {22, 0xbf}, {21, 0xbf}, {20, 0xbf},
        /* -25db,   -26.5db,    -28.85db,   -31.2db     -35.3db,    -39.4db,    -45.7db,    -60db */
        {19, 0xbf}, {18, 0xbf}, {17, 0xbd}, {15, 0xbf}, {13, 0xbf}, {11, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-4db
    {
        /* -4db,    -4.375db,   -4.75db,    -5.375db,   -6db        -6.75db,    -7.375db,   -8db */
        {36, 0xbf}, {36, 0xbe}, {36, 0xbd}, {35, 0xbe}, {34, 0xbf}, {34, 0xbd}, {33, 0xbe}, {32, 0xbf},
        /* -8.75db, -9.375db,   -10db,      -10.75db,   -11.375db   -12db,      -12.75db,   -13.375db */
        {32, 0xbd}, {31, 0xbe}, {30, 0xbf}, {30, 0xbd}, {29, 0xbe}, {28, 0xbf}, {28, 0xbd}, {27, 0xbe},
        /* -14.3db  -15.8db,    -17.4db,    -19db,      -20.5db,    -22.1db,    -23.5db,    -25db */
        {26, 0xbf}, {25, 0xbf}, {24, 0xbf}, {23, 0xbf}, {22, 0xbf}, {21, 0xbf}, {20, 0xbf}, {19, 0xbf},
        /* -26.5db, -28.1db,    -29.7,      -31.2db     -35.3db,    -39.4db,    -45.7db,    -60db */
        {18, 0xbf}, {17, 0xbf}, {16, 0xbf}, {15, 0xbf}, {13, 0xbf}, {11, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-5db
    {
        /* -5db,    -5.375db,   -5.75db,    -6.375db,   -7db        -7.75db,    -8.375db,   -9db */
        {35, 0xbf}, {35, 0xbe}, {35, 0xbd}, {34, 0xbe}, {33, 0xbf}, {33, 0xbd}, {32, 0xbe}, {31, 0xbf},
        /* -9.75db,  -10.375db,   -11db,    -11.75db,   -12.375db   -13db,      -13.75db,   -14.3db */
        {31, 0xbd}, {30, 0xbe}, {29, 0xbf}, {29, 0xbd}, {28, 0xbe}, {27, 0xbf}, {27, 0xbd}, {26, 0xbf},
        /* -15.8db, -17.4db,    -19db,      -20.5db,    -22.1db,    -23.5db,    -25db,      -26.5db, */
        {25, 0xbf}, {24, 0xbf}, {23, 0xbf}, {22, 0xbf}, {21, 0xbf}, {20, 0xbf}, {19, 0xbf}, {18, 0xbf},
        /* -28.1db,  -29.7,     -31.2db     -32.7db,    -35.3db,    -39.4db,    -45.7db,    -60db */
        {17, 0xbf}, {16, 0xbf}, {15, 0xbf}, {14, 0xbf}, {13, 0xbf}, {11, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-6db
    {
        /* -6db,    -6.375db,   -6.75db,    -7.375db,   -8db        -8.75db,    -9.375db,   -10db */
        {34, 0xbf}, {34, 0xbe}, {34, 0xbd}, {33, 0xbe}, {32, 0xbf}, {32, 0xbd}, {31, 0xbe}, {30, 0xbf},
        /* -10.75db, -11.375db,  -12db,     -12.75db,   -13.375db   -14.125db,  -15.05db,   -15.8db */
        {30, 0xbd}, {29, 0xbe}, {28, 0xbf}, {28, 0xbd}, {27, 0xbe}, {27, 0xbc}, {26, 0xbd}, {25, 0xbf},
        /* -17.4db, -19db,      -20.5db,    -22.1db,    -23.5db,    -25db,      -26.5db,    -28.1db,  */
        {24, 0xbf}, {23, 0xbf}, {22, 0xbf}, {21, 0xbf}, {20, 0xbf}, {19, 0xbf}, {18, 0xbf}, {17, 0xbf},
        /* -29.7db,  -31.2db    -32.7db,    -35.3db,    -37.5db,    -39.4db,    -45.7db,    -60db */
        {16, 0xbf}, {15, 0xbf}, {14, 0xbf}, {13, 0xbf}, {12, 0xbf}, {11, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-7db
    {
        /* -7db,    -7.375db,   -7.75db,    -8.375db,   -9db        -9.75db,    -10.375db,  -11db */
        {33, 0xbf}, {33, 0xbe}, {33, 0xbd}, {32, 0xbe}, {31, 0xbf}, {31, 0xbd}, {30, 0xbe}, {29, 0xbf},
        /* -11.75db, -12.375db,  -13db,     -13.75db,   -14.3db     -15.05db,   -15.87db,   -17.4db */
        {29, 0xbd}, {28, 0xbe}, {27, 0xbf}, {27, 0xbd}, {26, 0xbf}, {26, 0xbd}, {25, 0xbf}, {24, 0xbf},
        /* -19db,   -20.5db,    -22.1db,    -23.5db,    -25db,      -26.5db,    -28.1db,    -29.7db, */
        {23, 0xbf}, {22, 0xbf}, {21, 0xbf}, {20, 0xbf}, {19, 0xbf}, {18, 0xbf}, {17, 0xbf}, {16, 0xbf},
        /* -31.2db  -32.7db,    -35.3db,    -37.5db,    -39.4db,    -41.6db,    -45.7db,    -60db */
        {15, 0xbf}, {14, 0xbf}, {13, 0xbf}, {12, 0xbf}, {11, 0xbf}, {10, 0xbf}, {8, 0xbf},  {0, 0xbf},
    },
    //-8db
    {
        /* -8db,    -8.375db,   -8.75db,    -9.375db,   -10db       -10.75db,   -11.375db,  -12db */
        {32, 0xbf}, {32, 0xbe}, {32, 0xbd}, {31, 0xbe}, {30, 0xbf}, {30, 0xbd}, {29, 0xbe}, {28, 0xbf},
        /* -12.75db, -13.375db, -14.125db,  -14.675db,   -15.425db  -16.5db,   -17.4db,     -19db */
        {28, 0xbd}, {27, 0xbe}, {27, 0xbc}, {26, 0xbe}, {26, 0xbc}, {25, 0xbd}, {24, 0xbf}, {23, 0xbf},
        /* -20.5db, -22.1db,    -23.5db,    -25db,      -26.5db,    -28.1db,    -29.7db,    -31.2db */
        {22, 0xbf}, {21, 0xbf}, {20, 0xbf}, {19, 0xbf}, {18, 0xbf}, {17, 0xbf}, {16, 0xbf}, {15, 0xbf},
        /* -32.7db, -35.3db,    -37.5db,    -39.4db,    -41.6db,    -43.7db,    -45.7db,    -60db */
        {14, 0xbf}, {13, 0xbf}, {12, 0xbf}, {11, 0xbf}, {10, 0xbf}, {9, 0xbf},  {8, 0xbf},  {0, 0xbf},
    },
    //-9db
    {
        /* -9db,    -9.375db,   -9.75db,    -10.375db,  -11db       -11.75db,   -12.375db,  -13db */
        {31, 0xbf}, {31, 0xbe}, {31, 0xbd}, {30, 0xbe}, {29, 0xbf}, {29, 0xbd}, {28, 0xbe}, {27, 0xbf},
        /* -13.75db, -14.3db,   -15.05db,   -15.87db,   -17db,      -18.15db,   -19db,      -20.5db */
        {27, 0xbd}, {26, 0xbf}, {26, 0xbd}, {25, 0xbf}, {25, 0xbc}, {24, 0xbd}, {23, 0xbf}, {22, 0xbf},
        /* -22.1db,  -23.5db,   -25db,      -26.5db,    -28.1db,    -29.7db,    -31.2db,    -32.7db */
        {21, 0xbf}, {20, 0xbf}, {19, 0xbf}, {18, 0xbf}, {17, 0xbf}, {16, 0xbf}, {15, 0xbf}, {14, 0xbf},
        /* -35.3db,  -37.5db,   -39.4db,    -41.6db,    -43.7db,    -45.7db,    -47.6db,    -60db */
        {13, 0xbf}, {12, 0xbf}, {11, 0xbf}, {10, 0xbf}, {9, 0xbf},  {8, 0xbf},  {7, 0xbf},  {0, 0xbf},
    },
};

#else

const vol_hard_t g_hard_volume_table[VOLUME_VALUE_MAX+1] =
{
    /* 0db,     -0.375db,   -0.75db,    -1.5b,      -2.25db     -3db,       -3.75db,    -4.5db */
    {40, 0xbf}, {40, 0xbe}, {40, 0xbd}, {40, 0xbb}, {40, 0xb9}, {40, 0xb7}, {40, 0xb5}, {40, 0xb3},
    /* -4.875db, -5.625db,   -6.375db,  -7.125db,   -7.5db      -8.25db,    -9db,       -9.375db */
    {40, 0xb2}, {40, 0xb0}, {40, 0xae}, {40, 0xac}, {40, 0xab}, {40, 0xa9}, {40, 0xa7}, {40, 0xa6},
    /* -10.125db, -11.25db,  -12db,      -13.125db, -14.25db    -15.75db,   -17.625db,  -19.125db */
    {40, 0xa4}, {40, 0xa1}, {40, 0x9f}, {40, 0x9c}, {40, 0x99}, {40, 0x95}, {40, 0x90}, {40, 0x8c},
    /* -21.375db,-23.625db,  -25.875db,  -28.125db, -31.5db     -35.625db,  -41.625db,      mute */
    {40, 0x86}, {40, 0x80}, {40, 0x7a}, {40, 0x74}, {40, 0x6b}, {40, 0x60}, {40, 0x50}, {40, 0x00},
};

//兼容标准模型下的音量表
const vol_hard_t g_hard_volume_table_sm[VOLUME_VALUE_MAX+1] =
{
    /* 0db,         0db,    -0.375db,    -0.375db,   -0.75db     -0.75db,     -1.5db,    -1.5db */
    {40, 0xbf}, {40, 0xbf}, {40, 0xbe}, {40, 0xbe}, {40, 0xbd}, {40, 0xbd}, {40, 0xbb}, {40, 0xbb},
    /* -2.25db,   -2.25db,     -3db,       -3db,     -5.625db,    -5.625db,  -7.125db,   -7.125db */
    {40, 0xb9}, {40, 0xb9}, {40, 0xb7}, {40, 0xb7}, {40, 0xb0}, {40, 0xb0}, {40, 0xac}, {40, 0xac},
    /*-9.375db,  -9.375db,   -11.25db,   -11.25db,   -13.125db   -13.125db,  -15.75db,   -15.75db */
    {40, 0xa6}, {40, 0xa6}, {40, 0xa1}, {40, 0xa1}, {40, 0x9c}, {40, 0x9c}, {40, 0x95}, {40, 0x95},
    /*-19.125db,-19.125db,  -23.625db,  -23.625db,   -31.5db     -31.5db ,     mute ,     mute */
    {40, 0x8c}, {40, 0x8c}, {40, 0x80}, {40, 0x80}, {40, 0x6b}, {40, 0x6b}, {40, 0x00}, {40, 0x00},
};

#endif

//for volume convert table
//0xc0 for 0db, step 0.125db, 0x3ff for mute
const uint16 g_hard_volume_table_i2s_pa[VOLUME_VALUE_MAX+1] =
{
    0x00aa, 0x00b0, 0x00b6, 0x00bc, 0x00c2, 0x00c8, 0x00ce, 0x00d4,
    0x00da, 0x00e0, 0x00e6, 0x00ec, 0x00f2, 0x00f8, 0x0100, 0x0108,
    0x0110, 0x0118, 0x0124, 0x0130, 0x013c, 0x0148, 0x0154, 0x0160,
    0x0170, 0x0180, 0x0198, 0x01b0, 0x01d0, 0x01f0, 0x0220, 0x03ff,
};

/*! \endcond */

